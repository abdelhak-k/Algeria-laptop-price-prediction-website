{% extends 'predictor/base.html' %}

{% block title %}Price Prediction Result{% endblock %}

{% block content %}
<!-- Floating Feedback Notifier -->
{% if result.success %}
<a href="#feedback-section" id="feedback-notifier" class="feedback-notifier" title="Help us improve!">
    <i class="fas fa-bell"></i>
    <span class="notifier-badge">1</span>
    <span class="notifier-text">Give Feedback</span>
</a>
{% endif %}

<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Result Card -->
        <div class="card mb-4">
            <div class="card-header text-center">
                <h2><i class="fas fa-chart-line me-2"></i>Prediction Result</h2>
            </div>
            <div class="card-body p-4">
                {% if result.success %}
                <div class="price-result mb-4">
                    <p class="mb-2"><i class="fas fa-tag me-2"></i>Estimated Price</p>
                    <h3>price = {{ result.predicted_price_formatted }}</h3>
                    <div class="mt-3" style="font-size: 0.8rem; opacity: 0.8; font-weight: 400;">
                        min_price = {{ result.min_price_formatted }} , max_price = {{ result.max_price_formatted }}
                    </div>
                </div>

                <!-- Specs Summary -->
                <div class="form-section">
                    <h5><i class="fas fa-list-ul me-2"></i>Laptop Specifications</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Brand:</th>
                                    <td>{{ form_data.brand }}</td>
                                </tr>
                                <tr>
                                    <th>Series:</th>
                                    <td>{{ form_data.series }}</td>
                                </tr>
                                <tr>
                                    <th>Condition:</th>
                                    <td>{{ form_data.condition }}</td>
                                </tr>
                                <tr>
                                    <th>CPU:</th>
                                    <td>{{ form_data.cpu_family }}{% if form_data.cpu_generation and form_data.cpu_generation != '0' %} Gen {{ form_data.cpu_generation }}{% endif %}{% if form_data.cpu_suffix %} {{ form_data.cpu_suffix }}{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Professional:</th>
                                    <td>{% if form_data.is_pro %}Yes{% else %}No{% endif %}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>GPU:</th>
                                    <td>{{ form_data.gpu_tier }}{% if form_data.gpu_suffix %} {{ form_data.gpu_suffix }}{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>RAM:</th>
                                    <td>{{ form_data.ram_size_gb }} GB {% if form_data.ram_type_class and form_data.ram_type_class != 'Unknown' %}({{ form_data.ram_type_class }}){% endif %}</td>
                                </tr>
                                <tr>
                                    <th>SSD:</th>
                                    <td>{{ form_data.ssd_size_gb }} GB</td>
                                </tr>
                                <tr>
                                    <th>HDD:</th>
                                    <td>{% if form_data.hdd_size_gb %}{{ form_data.hdd_size_gb }} GB{% else %}None{% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Screen:</th>
                                    <td>{{ form_data.screen_size }}" {% if form_data.resolution_class and form_data.resolution_class != 'Unknown' %}({{ form_data.resolution_class }}){% endif %}</td>
                                </tr>
                                <tr>
                                    <th>Year:</th>
                                    <td>{{ form_data.listing_year }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Hardware Match Information -->
                {% if result.cpu_match_info or result.gpu_match_info %}
                <div class="form-section mt-4">
                    <h5><i class="fas fa-search me-2"></i>Hardware Match Information</h5>
                    <p class="text-muted small mb-3">These are the actual hardware components from our database that were used to estimate performance:</p>

                    <div class="row">
                        <!-- CPU Match Info -->
                        {% if result.cpu_match_info %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-microchip me-2"></i>CPU Match</h6>
                                </div>
                                <div class="card-body">
                                    <p class="mb-2">
                                        <strong>Search Pattern:</strong><br>
                                        <code class="d-block mt-1">{{ result.cpu_match_info.search_pattern }}</code>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Matched CPU:</strong><br>
                                        <span class="badge bg-success mt-1">{{ result.cpu_match_info.matched_cpu }}</span>
                                    </p>
                                    <p class="mb-0">
                                        <strong>Similarity:</strong>
                                        <div class="progress mt-2" style="height: 25px;">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ result.cpu_match_info.similarity }}%;" aria-valuenow="{{ result.cpu_match_info.similarity }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ result.cpu_match_info.similarity }}%
                                            </div>
                                        </div>
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- GPU Match Info -->
                        {% if result.gpu_match_info %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-tv me-2"></i>GPU Match</h6>
                                </div>
                                <div class="card-body">
                                    <p class="mb-2">
                                        <strong>Search Pattern:</strong><br>
                                        <code class="d-block mt-1">{{ result.gpu_match_info.search_pattern }}</code>
                                    </p>
                                    <p class="mb-2">
                                        <strong>Matched GPU:</strong><br>
                                        <span class="badge bg-success mt-1">{{ result.gpu_match_info.matched_gpu }}</span>
                                    </p>
                                    <p class="mb-0">
                                        <strong>Similarity:</strong>
                                        {% if result.gpu_match_info.match_type == 'exact' %}
                                        <div class="alert alert-success mt-2 mb-0 py-2">
                                            <i class="fas fa-check-circle me-1"></i>Exact Match (100%)
                                        </div>
                                        {% else %}
                                        <div class="progress mt-2" style="height: 25px;">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ result.gpu_match_info.similarity }}%;" aria-valuenow="{{ result.gpu_match_info.similarity }}" aria-valuemin="0" aria-valuemax="100">
                                                {{ result.gpu_match_info.similarity }}%
                                            </div>
                                        </div>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Feature Values Used for Prediction -->
                {% if result.feature_values %}
                <div class="form-section mt-4">
                    <h5><i class="fas fa-calculator me-2"></i>Feature Values Used for Prediction</h5>
                    <p class="text-muted small mb-3">These are the actual computed values that were fed into the machine learning model:</p>

                    <!-- Performance Metrics -->
                    <h6 class="mt-3 mb-2"><i class="fas fa-tachometer-alt me-2"></i>Performance Metrics</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Feature</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for feat in result.feature_values.numeric %}
                                <tr>
                                    <td>{{ feat.name }}</td>
                                    <td><strong>{{ feat.value_formatted }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Derived Features -->
                    <h6 class="mt-3 mb-2"><i class="fas fa-cogs me-2"></i>Derived Features</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Feature</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for feat in result.feature_values.derived %}
                                <tr>
                                    <td>{{ feat.name }} <span class="text-muted small">{{ feat.description }}</span></td>
                                    <td><strong>{{ feat.value_formatted }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Binary & Categorical Features -->
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mt-3 mb-2"><i class="fas fa-toggle-on me-2"></i>Binary Features</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <tbody>
                                        {% for feat in result.feature_values.binary %}
                                        <tr>
                                            <td>{{ feat.name }}</td>
                                            <td><strong>{{ feat.value }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mt-3 mb-2"><i class="fas fa-tags me-2"></i>Categorical Features</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <tbody>
                                        {% for feat in result.feature_values.categorical %}
                                        <tr>
                                            <td>{{ feat.name }}</td>
                                            <td><strong>{{ feat.value }}</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Feature Importance -->
                {% if result.feature_importance %}
                <div class="form-section mt-4">
                    <h5><i class="fas fa-chart-bar me-2"></i>What Matters Most for This Price</h5>
                    <p class="text-muted small mb-3">Top factors influencing this laptop's price prediction:</p>
                    <div class="feature-importance-list">
                        {% for feature in result.feature_importance %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-medium">{{ forloop.counter }}. {{ feature.feature }}</span>
                                <span class="badge bg-primary">{{ feature.importance_formatted }}</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" role="progressbar" style="width: {{ feature.importance }}%;" aria-valuenow="{{ feature.importance }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% else %}
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Prediction Error</h4>
                    <p>{{ result.error }}</p>
                    <hr>
                    <p class="mb-0">Please make sure the model has been trained and saved properly.</p>
                </div>
                {% endif %}

                <div class="text-center mt-4">
                    <button onclick="window.history.back()" class="btn btn-primary btn-predict">
                        <i class="fas fa-arrow-left me-2"></i>Go Back
                    </button>
                </div>
            </div>
        </div>

        <!-- Feedback Form Card -->
        {% if result.success %}
        <div id="feedback-section" class="card mb-4 feedback-card">
            <!-- Form state (visible until submitted) -->
            <div id="feedback-form-wrapper" class="feedback-form-wrapper">
                <div class="card-header feedback-card-header">
                    <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Help Us Improve</h5>
                </div>
                <div class="card-body p-4">
                    <div class="feedback-intro">
                        <div class="feedback-intro-icon"><i class="fas fa-heart"></i></div>
                        <div>
                            <strong>Thank you for helping us improve!</strong><br>
                            <span class="text-muted">Your feedback is invaluable â€” even a quick response helps us make better predictions for everyone in Algeria.</span>
                        </div>
                    </div>

                    <form id="feedback-form" method="post" action="{% url 'predictor:submit_feedback' %}">
                        {% csrf_token %}
                        <input type="hidden" name="feedback_id" value="{{ feedback_id }}">

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ feedback_form.is_accurate.label }}</label>
                                {{ feedback_form.is_accurate }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ feedback_form.actual_price.label }}</label>
                                {{ feedback_form.actual_price }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">{{ feedback_form.feedback_text.label }}</label>
                            {{ feedback_form.feedback_text }}
                        </div>

                        <div id="feedback-form-error" class="alert alert-danger py-2 mb-3 d-none" role="alert"></div>

                        <div class="text-center">
                            <button type="submit" id="feedback-submit-btn" class="btn btn-success btn-submit-feedback">
                                <span class="btn-text"><i class="fas fa-paper-plane me-2"></i>Submit Feedback</span>
                                <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-2" role="status"></span>Sending...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Success state (hidden until after submit) -->
            <div id="feedback-success-state" class="feedback-success-state" aria-hidden="true">
                <div class="success-state-inner">
                    <div class="success-checkmark-wrap">
                        <div class="success-checkmark-circle"></div>
                        <svg class="success-checkmark" viewBox="0 0 52 52" aria-hidden="true">
                            <path class="success-checkmark-path" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                        </svg>
                    </div>
                    <h5 class="success-title">Feedback received</h5>
                    <p class="success-message">Thank you! Your response helps us improve predictions for everyone in Algeria.</p>
                    <div class="success-footer">
                        <i class="fas fa-leaf success-footer-icon"></i>
                        <span>We appreciate you</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Tips Card -->
        <div class="card">
            <div class="card-body p-4">
                <h5><i class="fas fa-lightbulb me-2 text-warning"></i>Price Factors</h5>
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Condition:</strong> "Never Used" laptops command 15-25% premium over "Good Condition"</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Brand:</strong> Apple and premium brands have higher resale value</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>CPU Generation:</strong> Newer generations significantly impact price</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>GPU:</strong> Dedicated graphics add substantial value, especially RTX cards</li>
                    <li class="mb-2"><i class="fas fa-check text-success me-2"></i><strong>Storage:</strong> SSDs are valued higher than HDDs</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
html {
    scroll-behavior: smooth;
}

/* Feedback card */
.feedback-card {
    border: 2px solid #198754;
    overflow: hidden;
}

.feedback-card-header {
    background: linear-gradient(135deg, #198754, #20c997);
    color: white;
    padding: 1rem 1.5rem;
    border-bottom: none;
}

.feedback-intro {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    border: none;
}

.feedback-intro-icon {
    font-size: 1.75rem;
    color: #d21034;
    flex-shrink: 0;
}

.btn-submit-feedback {
    background: linear-gradient(135deg, #198754, #20c997);
    border: none;
    padding: 0.6rem 1.75rem;
    font-weight: 600;
    border-radius: 50px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-submit-feedback:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.4);
}

/* Success state */
.feedback-success-state {
    display: none;
    padding: 2.5rem 2rem;
    text-align: center;
    animation: successFadeIn 0.5s ease-out;
}

.feedback-success-state.is-visible {
    display: block;
}

.feedback-form-wrapper.is-hidden {
    display: none !important;
}

@keyframes successFadeIn {
    from {
        opacity: 0;
        transform: scale(0.96);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.success-state-inner {
    max-width: 360px;
    margin: 0 auto;
}

/* Checkmark animation */
.success-checkmark-wrap {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    position: relative;
}

.success-checkmark-circle {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background: linear-gradient(135deg, #198754, #20c997);
    opacity: 0.15;
    animation: successCirclePulse 0.6s ease-out 0.3s both;
}

.success-checkmark {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
}

.success-checkmark-path {
    stroke: #198754;
    stroke-width: 3;
    stroke-linecap: round;
    stroke-linejoin: round;
    fill: none;
    stroke-dasharray: 48;
    stroke-dashoffset: 48;
    animation: successCheckStroke 0.45s ease-out 0.35s forwards;
}

@keyframes successCirclePulse {
    from {
        transform: scale(0.6);
        opacity: 0.3;
    }
    to {
        transform: scale(1);
        opacity: 0.15;
    }
}

@keyframes successCheckStroke {
    to {
        stroke-dashoffset: 0;
    }
}

.success-title {
    font-weight: 700;
    color: #0d4d2a;
    margin-bottom: 0.5rem;
    font-size: 1.35rem;
}

.success-message {
    color: #495057;
    font-size: 0.95rem;
    margin-bottom: 1.25rem;
    line-height: 1.5;
}

.success-footer {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #198754;
    font-size: 0.9rem;
    font-weight: 500;
}

.success-footer-icon {
    font-size: 1rem;
    opacity: 0.9;
}

.feedback-notifier {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1050;
    display: flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, #198754, #20c997);
    color: white;
    padding: 10px 18px;
    border-radius: 50px;
    text-decoration: none;
    box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4);
    transition: all 0.3s ease;
    animation: notifier-pulse 2s infinite;
    font-weight: 600;
    font-size: 0.9rem;
}

.feedback-notifier:hover {
    color: white;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 6px 20px rgba(25, 135, 84, 0.6);
    animation: none;
}

.feedback-notifier i {
    font-size: 1.1rem;
    animation: bell-ring 2s ease infinite;
}

.notifier-badge {
    background: #dc3545;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    position: absolute;
    top: -4px;
    left: -4px;
}

@keyframes notifier-pulse {
    0% { box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4); }
    50% { box-shadow: 0 4px 25px rgba(25, 135, 84, 0.7); }
    100% { box-shadow: 0 4px 15px rgba(25, 135, 84, 0.4); }
}

@keyframes bell-ring {
    0% { transform: rotate(0); }
    10% { transform: rotate(14deg); }
    20% { transform: rotate(-14deg); }
    30% { transform: rotate(10deg); }
    40% { transform: rotate(-8deg); }
    50% { transform: rotate(0); }
    100% { transform: rotate(0); }
}

.feedback-notifier.hidden {
    opacity: 0;
    pointer-events: none;
    transform: translateX(100px);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var notifier = document.getElementById('feedback-notifier');
    var feedbackSection = document.getElementById('feedback-section');
    var feedbackForm = document.getElementById('feedback-form');
    var feedbackFormWrapper = document.getElementById('feedback-form-wrapper');
    var feedbackSuccessState = document.getElementById('feedback-success-state');
    var feedbackSubmitBtn = document.getElementById('feedback-submit-btn');
    var feedbackFormError = document.getElementById('feedback-form-error');

    // Hide notifier when feedback section is in view or when success state is shown
    if (notifier && feedbackSection) {
        var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                var successVisible = feedbackSuccessState && feedbackSuccessState.classList.contains('is-visible');
                if (entry.isIntersecting || successVisible) {
                    notifier.classList.add('hidden');
                } else {
                    notifier.classList.remove('hidden');
                }
            });
        }, { threshold: 0.3 });
        observer.observe(feedbackSection);
    }

    // AJAX feedback submission
    if (feedbackForm && feedbackFormWrapper && feedbackSuccessState) {
        feedbackForm.addEventListener('submit', function(e) {
            e.preventDefault();

            var btnText = feedbackSubmitBtn.querySelector('.btn-text');
            var btnLoading = feedbackSubmitBtn.querySelector('.btn-loading');
            feedbackFormError.classList.add('d-none');
            feedbackFormError.textContent = '';
            feedbackSubmitBtn.disabled = true;
            if (btnText) btnText.classList.add('d-none');
            if (btnLoading) btnLoading.classList.remove('d-none');

            var formData = new FormData(feedbackForm);
            var csrfToken = feedbackForm.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken.value);
            }

            fetch(feedbackForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(function(res) {
                return res.json().then(function(data) {
                    if (!res.ok) throw data;
                    return data;
                });
            })
            .then(function(data) {
                if (data.success) {
                    feedbackFormWrapper.classList.add('is-hidden');
                    feedbackSuccessState.classList.add('is-visible');
                    feedbackSuccessState.setAttribute('aria-hidden', 'false');
                    if (notifier) notifier.classList.add('hidden');
                }
            })
            .catch(function(err) {
                var message = (err && err.error) ? err.error : 'Something went wrong. Please try again.';
                feedbackFormError.textContent = message;
                feedbackFormError.classList.remove('d-none');
                feedbackSubmitBtn.disabled = false;
                if (btnText) btnText.classList.remove('d-none');
                if (btnLoading) btnLoading.classList.add('d-none');
            });
        });
    }
});
</script>
{% endblock %}